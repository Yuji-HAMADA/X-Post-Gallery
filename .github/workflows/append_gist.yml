name: Append Posts to Gist

on:
  workflow_dispatch:
    inputs:
      gist_id:
        description: '対象Gist ID'
        required: true
      user:
        description: 'ユーザID (例: travelbeauty8)　※ hashtag と排他'
        required: false
        default: ''
      hashtag:
        description: 'ハッシュタグ (#なし、例: aiart)　※ user と排他'
        required: false
        default: ''
      mode:
        description: '取得モード'
        required: true
        default: 'post_only'
        type: choice
        options:
          - post_only
          - all
      num_posts:
        description: '最大取得件数'
        required: true
        default: '100'
      stop_on_existing:
        description: '既存IDに当たったら停止（ストップオンモード）'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  append-gist:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-append-gist
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Python dependencies
        run: pip install playwright --quiet

      - name: Get Playwright version
        id: playwright-version
        run: echo "version=$(pip show playwright | grep Version | cut -d ' ' -f 2)" >> $GITHUB_OUTPUT

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.version }}

      - name: Install Playwright Browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: playwright install chromium --with-deps

      - name: Install Playwright dependencies (Always required)
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: playwright install-deps chromium

      - name: Create Auth File
        env:
          AUTH_DATA: ${{ secrets.AUTH_JSON }}
        run: |
          mkdir -p data
          printf "%s" "$AUTH_DATA" > data/auth.json
          if [ ! -s data/auth.json ]; then
            echo "❌ Error: data/auth.json is empty. Check GitHub Secret: AUTH_JSON"
            exit 1
          fi
          python3 -c "import json; json.load(open('data/auth.json'))" && echo "✅ auth.json is valid JSON" || (echo "❌ Error: auth.json is NOT valid JSON format"; exit 1)

      - name: Append Posts to Gist
        env:
          GH_TOKEN: ${{ secrets.GIST_TOKEN }}
        run: |
          chmod +x append_gist.sh
          STOP_FLAG=""
          if [ "${{ github.event.inputs.stop_on_existing }}" = "true" ]; then
            STOP_FLAG="-s"
          fi
          TARGET_FLAG=""
          if [ -n "${{ github.event.inputs.user }}" ]; then
            TARGET_FLAG="-u ${{ github.event.inputs.user }}"
          elif [ -n "${{ github.event.inputs.hashtag }}" ]; then
            TARGET_FLAG="-t ${{ github.event.inputs.hashtag }}"
          else
            echo "❌ Error: user または hashtag のどちらかを指定してください"
            exit 1
          fi
          ./append_gist.sh \
            -g "${{ github.event.inputs.gist_id }}" \
            $TARGET_FLAG \
            -m "${{ github.event.inputs.mode }}" \
            -n "${{ github.event.inputs.num_posts }}" \
            $STOP_FLAG
